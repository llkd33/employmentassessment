<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ìš©ì ìƒì„¸ ì •ë³´ - ì‹ ì…ì‚¬ì› ì—­ëŸ‰ê²€ì‚¬</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="admin-test-detail-modal.html">
    <style>
        body {
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        
        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .admin-header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .back-btn, .logout-btn {
            background: #34495e;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }
        
        .back-btn:hover, .logout-btn:hover {
            background: #2c3e50;
        }
        
        .detail-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .user-info-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .user-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .user-info-header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 24px;
        }
        
        .user-status {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .test-results-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .section-header {
            margin-bottom: 20px;
        }
        
        .section-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 20px;
        }
        
        .test-list {
            margin-top: 20px;
        }
        
        .test-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .test-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .test-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .test-date {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .test-score {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .test-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .competency-score {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .competency-name {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .competency-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .chart-container {
            margin-top: 30px;
            height: 400px;
            position: relative;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state h4 {
            color: #666;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            margin: 20px 0;
        }
        
        .assign-company-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ffeaa7;
        }
        
        .assign-company-section h4 {
            margin: 0 0 15px 0;
            color: #856404;
        }
        
        .assign-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .assign-form select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .assign-btn {
            padding: 8px 20px;
            background: #f0ad4e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .assign-btn:hover {
            background: #ec971f;
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="admin-header-content">
            <h1>ì‚¬ìš©ì ìƒì„¸ ì •ë³´</h1>
            <div class="header-actions">
                <a href="admin-dashboard.html" class="back-btn">ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>
    
    <div class="detail-container">
        <!-- ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´ -->
        <div class="user-info-section">
            <div class="user-info-header">
                <h2 id="userName">-</h2>
                <span class="user-status">í™œì„±</span>
            </div>
            
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">ì´ë©”ì¼</div>
                    <div class="info-value" id="userEmail">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì†Œì† íšŒì‚¬</div>
                    <div class="info-value" id="userCompany">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ê°€ì…ì¼</div>
                    <div class="info-value" id="userJoinDate">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ë¡œê·¸ì¸ ë°©ì‹</div>
                    <div class="info-value" id="userLoginType">-</div>
                </div>
            </div>
            
            <!-- íšŒì‚¬ í• ë‹¹ ì„¹ì…˜ (ë¯¸í• ë‹¹ ì‚¬ìš©ììš©) -->
            <div id="assignCompanySection" class="assign-company-section" style="display: none;">
                <h4>íšŒì‚¬ í• ë‹¹</h4>
                <p>ì´ ì‚¬ìš©ìëŠ” ì•„ì§ íšŒì‚¬ì— í• ë‹¹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                <div class="assign-form">
                    <select id="companySelect">
                        <option value="">íšŒì‚¬ ì„ íƒ...</option>
                    </select>
                    <button class="assign-btn" onclick="assignToCompany()">í• ë‹¹í•˜ê¸°</button>
                </div>
            </div>
        </div>
        
        <!-- í…ŒìŠ¤íŠ¸ ê²°ê³¼ -->
        <div class="test-results-section">
            <div class="section-header">
                <h3>í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì´ë ¥</h3>
            </div>
            
            <div id="testResultsContainer">
                <div class="loading">í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            
            <!-- ì ìˆ˜ ì¶”ì´ ì°¨íŠ¸ -->
            <div class="chart-container" id="chartContainer" style="display: none;">
                <canvas id="scoreProgressChart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        // API URL ì„¤ì • - íŒŒì¼ë¡œ ì§ì ‘ ì—´ ë•Œë„ ì‘ë™í•˜ë„ë¡ ìˆ˜ì •
        const API_URL = window.location.protocol === 'file:' 
            ? 'http://localhost:3000'
            : (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:3000' 
                : window.location.origin);
        
        let currentUser = null;
        let chartInstance = null;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAuth();
            const userId = getUserIdFromUrl();
            if (userId) {
                loadUserDetail(userId);
            } else {
                showError('ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        });
        
        // URLì—ì„œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
        function getUserIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('userId');
        }
        
        // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
        function checkAdminAuth() {
            const token = localStorage.getItem('adminToken');
            const adminUser = JSON.parse(localStorage.getItem('adminUser') || '{}');
            
            if (!token || !adminUser.role || !['super_admin', 'company_admin'].includes(adminUser.role)) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'admin-login.html';
                return;
            }
        }
        
        // ì‚¬ìš©ì ìƒì„¸ ì •ë³´ ë¡œë“œ
        async function loadUserDetail(userId) {
            try {
                const response = await fetch(`${API_URL}/api/admin/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    displayUserInfo(data.user);
                    displayTestResults(data.testResults);
                    
                    // íšŒì‚¬ ë¯¸í• ë‹¹ ì‚¬ìš©ìì¸ ê²½ìš°
                    if (!data.user.company_id) {
                        showAssignCompanySection();
                    }
                } else if (response.status === 404) {
                    showError('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                } else if (response.status === 403) {
                    showError('ì´ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë³¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                } else {
                    showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ìƒì„¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        function displayUserInfo(user) {
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userCompany').textContent = user.company_name || 'ë¯¸í• ë‹¹';
            document.getElementById('userJoinDate').textContent = 
                new Date(user.created_at).toLocaleDateString();
            
            const loginTypeMap = {
                'email': 'ì´ë©”ì¼',
                'kakao': 'ì¹´ì¹´ì˜¤',
                'anonymous': 'ìµëª…',
                'temp': 'ì„ì‹œ'
            };
            document.getElementById('userLoginType').textContent = 
                loginTypeMap[user.login_type] || user.login_type;
        }
        
        // í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ
        function displayTestResults(testResults) {
            const container = document.getElementById('testResultsContainer');
            
            if (!testResults || testResults.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                        <p>ì•„ì§ ì—­ëŸ‰ê²€ì‚¬ë¥¼ ì§„í–‰í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="test-list">';
            
            testResults.forEach((result, index) => {
                const testDate = new Date(result.test_date);
                const dateStr = testDate.toLocaleDateString();
                const timeStr = testDate.toLocaleTimeString();
                
                html += `
                    <div class="test-item" onclick="viewTestDetail('${result.result_id}')">
                        <div class="test-item-header">
                            <div class="test-date">
                                <strong>${dateStr}</strong> ${timeStr}
                                ${index === 0 ? '<span style="color: #3498db; margin-left: 10px;">(ìµœì‹ )</span>' : ''}
                            </div>
                            <div class="test-score">${result.overall_score}ì </div>
                        </div>
                        <div class="test-details">
                            <div class="competency-score">
                                <div class="competency-name">ë¬¸ì œí•´ê²°</div>
                                <div class="competency-value">${result.problem_solving_score}</div>
                            </div>
                            <div class="competency-score">
                                <div class="competency-name">ì»¤ë®¤ë‹ˆì¼€ì´ì…˜</div>
                                <div class="competency-value">${result.communication_score}</div>
                            </div>
                            <div class="competency-score">
                                <div class="competency-name">ë¦¬ë”ì‹­</div>
                                <div class="competency-value">${result.leadership_score}</div>
                            </div>
                            <div class="competency-score">
                                <div class="competency-name">ì°½ì˜ì„±</div>
                                <div class="competency-value">${result.creativity_score}</div>
                            </div>
                            <div class="competency-score">
                                <div class="competency-name">íŒ€ì›Œí¬</div>
                                <div class="competency-value">${result.teamwork_score}</div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button onclick="viewTestDetail('${result.result_id}')" style="padding: 8px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                ìƒì„¸ ë¶„ì„ ë³´ê¸°
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // ì°¨íŠ¸ í‘œì‹œ
            if (testResults.length > 1) {
                document.getElementById('chartContainer').style.display = 'block';
                displayScoreProgressChart(testResults);
            }
        }
        
        // ì ìˆ˜ ì¶”ì´ ì°¨íŠ¸
        function displayScoreProgressChart(testResults) {
            const ctx = document.getElementById('scoreProgressChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // ìµœê·¼ 10ê°œ ê²°ê³¼ë§Œ í‘œì‹œ
            const recentResults = testResults.slice(0, 10).reverse();
            
            const labels = recentResults.map(r => 
                new Date(r.test_date).toLocaleDateString()
            );
            
            const datasets = [
                {
                    label: 'ì „ì²´ ì ìˆ˜',
                    data: recentResults.map(r => r.overall_score),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 3,
                    tension: 0.3
                },
                {
                    label: 'ë¬¸ì œí•´ê²°',
                    data: recentResults.map(r => r.problem_solving_score),
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    hidden: true
                },
                {
                    label: 'ì»¤ë®¤ë‹ˆì¼€ì´ì…˜',
                    data: recentResults.map(r => r.communication_score),
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243, 156, 18, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    hidden: true
                },
                {
                    label: 'ë¦¬ë”ì‹­',
                    data: recentResults.map(r => r.leadership_score),
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    hidden: true
                },
                {
                    label: 'ì°½ì˜ì„±',
                    data: recentResults.map(r => r.creativity_score),
                    borderColor: '#9b59b6',
                    backgroundColor: 'rgba(155, 89, 182, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    hidden: true
                },
                {
                    label: 'íŒ€ì›Œí¬',
                    data: recentResults.map(r => r.teamwork_score),
                    borderColor: '#1abc9c',
                    backgroundColor: 'rgba(26, 188, 156, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    hidden: true
                }
            ];
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ì ìˆ˜ ë³€í™” ì¶”ì´'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }
        
        // íšŒì‚¬ í• ë‹¹ ì„¹ì…˜ í‘œì‹œ
        async function showAssignCompanySection() {
            const adminUser = JSON.parse(localStorage.getItem('adminUser') || '{}');
            
            // íšŒì‚¬ ê´€ë¦¬ìëŠ” ìê¸° íšŒì‚¬ë¡œë§Œ í• ë‹¹ ê°€ëŠ¥
            if (adminUser.role === 'company_admin') {
                document.getElementById('assignCompanySection').style.display = 'block';
                const select = document.getElementById('companySelect');
                select.innerHTML = `
                    <option value="${adminUser.companyId}">${adminUser.companyName}</option>
                `;
            } 
            // ìŠˆí¼ ê´€ë¦¬ìëŠ” ëª¨ë“  íšŒì‚¬ ì„ íƒ ê°€ëŠ¥
            else if (adminUser.role === 'super_admin') {
                document.getElementById('assignCompanySection').style.display = 'block';
                await loadCompaniesForAssign();
            }
        }
        
        // íšŒì‚¬ ëª©ë¡ ë¡œë“œ (í• ë‹¹ìš©)
        async function loadCompaniesForAssign() {
            try {
                const response = await fetch(`${API_URL}/api/admin/companies`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('companySelect');
                    
                    select.innerHTML = '<option value="">íšŒì‚¬ ì„ íƒ...</option>';
                    data.companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.id;
                        option.textContent = company.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('íšŒì‚¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // íšŒì‚¬ì— í• ë‹¹
        async function assignToCompany() {
            const companyId = document.getElementById('companySelect').value;
            
            if (!companyId) {
                alert('íšŒì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch(
                    `${API_URL}/api/admin/users/${currentUser.user_id}/assign`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ companyId })
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`${data.companyName}ì— í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    location.reload();
                } else {
                    const error = await response.json();
                    alert(error.error || 'í• ë‹¹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('íšŒì‚¬ í• ë‹¹ ì˜¤ë¥˜:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // í…ŒìŠ¤íŠ¸ ìƒì„¸ ë³´ê¸°
        async function viewTestDetail(resultId) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`${API_URL}/api/admin/test-results/${resultId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showTestDetailModal(data);
                } else {
                    alert('í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // í…ŒìŠ¤íŠ¸ ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ
        function showTestDetailModal(data) {
            // ì™¸ë¶€ ëª¨ë‹¬ íŒŒì¼ì˜ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •
            if (typeof openTestDetailModal === 'function') {
                openTestDetailModal(data.testResult.result_id);
            } else {
                // í´ë°±: ëª¨ë‹¬ íŒŒì¼ì´ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš°
                loadTestDetailModal().then(() => {
                    openTestDetailModal(data.testResult.result_id);
                });
            }
        }
        
        // ëª¨ë‹¬ íŒŒì¼ ë™ì  ë¡œë“œ
        async function loadTestDetailModal() {
            try {
                const response = await fetch('admin-test-detail-modal.html');
                const html = await response.text();
                
                // HTMLì„ íŒŒì‹±í•˜ì—¬ ëª¨ë‹¬ê³¼ ìŠ¤í¬ë¦½íŠ¸ ì¶”ì¶œ
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // ëª¨ë‹¬ HTML ì¶”ê°€
                const modal = doc.getElementById('testDetailModal');
                if (modal && !document.getElementById('testDetailModal')) {
                    document.body.appendChild(modal);
                }
                
                // ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
                const scripts = doc.querySelectorAll('script');
                scripts.forEach(script => {
                    if (script.src) {
                        // ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸
                        const newScript = document.createElement('script');
                        newScript.src = script.src;
                        document.head.appendChild(newScript);
                    } else {
                        // ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸
                        eval(script.textContent);
                    }
                });
                
                // ìŠ¤íƒ€ì¼ ì¶”ê°€
                const styles = doc.querySelectorAll('style');
                styles.forEach(style => {
                    document.head.appendChild(style.cloneNode(true));
                });
                
            } catch (error) {
                console.error('ëª¨ë‹¬ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // í…ŒìŠ¤íŠ¸ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸° (í´ë°±ìš©)
        if (typeof window.closeTestDetailModal === 'undefined') {
            window.closeTestDetailModal = function() {
                const modal = document.getElementById('testDetailModal');
                if (modal) {
                    modal.remove();
                }
            }
        }
        
        // ì ìˆ˜ ë“±ê¸‰ ë°˜í™˜
        function getGrade(score) {
            if (score >= 90) return 'ğŸ† ë§¤ìš° ìš°ìˆ˜';
            if (score >= 80) return 'ğŸŒŸ ìš°ìˆ˜';
            if (score >= 70) return 'ğŸ‘ ì–‘í˜¸';
            if (score >= 60) return 'âœ”ï¸ ë³´í†µ';
            return 'ğŸ“ˆ ê°œì„  í•„ìš”';
        }
        
        // ì—­ëŸ‰ë³„ ì¹´ë“œ ìƒì„±
        function getCompetencyCards(result) {
            const competencies = [
                { name: 'ë¬¸ì œí•´ê²°', score: result.problem_solving_score, color: '#e74c3c' },
                { name: 'ì»¤ë®¤ë‹ˆì¼€ì´ì…˜', score: result.communication_score, color: '#f39c12' },
                { name: 'ë¦¬ë”ì‹­', score: result.leadership_score, color: '#27ae60' },
                { name: 'ì°½ì˜ì„±', score: result.creativity_score, color: '#9b59b6' },
                { name: 'íŒ€ì›Œí¬', score: result.teamwork_score, color: '#3498db' }
            ];
            
            return competencies.map(comp => `
                <div style="background: white; border: 1px solid #e9ecef; padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${comp.name}</div>
                    <div style="font-size: 28px; font-weight: bold; color: ${comp.color}; margin-bottom: 10px;">${comp.score}</div>
                    <div style="height: 4px; background: #e9ecef; border-radius: 2px; overflow: hidden;">
                        <div style="height: 100%; background: ${comp.color}; width: ${comp.score}%; transition: width 0.5s;"></div>
                    </div>
                </div>
            `).join('');
        }
        
        // ì—­ëŸ‰ë³„ ì¹´ë“œ ìƒì„± (í‰ê·  í¬í•¨)
        function getCompetencyCardsWithAverage(result, companyAverage) {
            const competencies = [
                { 
                    name: 'ë¬¸ì œí•´ê²°', 
                    score: result.problem_solving_score, 
                    avg: companyAverage ? parseFloat(companyAverage.avg_problem_solving) : null,
                    color: '#e74c3c' 
                },
                { 
                    name: 'ì»¤ë®¤ë‹ˆì¼€ì´ì…˜', 
                    score: result.communication_score,
                    avg: companyAverage ? parseFloat(companyAverage.avg_communication) : null,
                    color: '#f39c12' 
                },
                { 
                    name: 'ë¦¬ë”ì‹­', 
                    score: result.leadership_score,
                    avg: companyAverage ? parseFloat(companyAverage.avg_leadership) : null,
                    color: '#27ae60' 
                },
                { 
                    name: 'ì°½ì˜ì„±', 
                    score: result.creativity_score,
                    avg: companyAverage ? parseFloat(companyAverage.avg_creativity) : null,
                    color: '#9b59b6' 
                },
                { 
                    name: 'íŒ€ì›Œí¬', 
                    score: result.teamwork_score,
                    avg: companyAverage ? parseFloat(companyAverage.avg_teamwork) : null,
                    color: '#3498db' 
                }
            ];
            
            return competencies.map(comp => {
                const diff = comp.avg ? (comp.score - comp.avg).toFixed(1) : null;
                return `
                    <div style="background: white; border: 1px solid #e9ecef; padding: 20px; border-radius: 8px; text-align: center; position: relative;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${comp.name}</div>
                        <div style="font-size: 28px; font-weight: bold; color: ${comp.color}; margin-bottom: 10px;">${comp.score}</div>
                        ${comp.avg ? `
                            <div style="font-size: 11px; color: #999; margin-bottom: 5px;">
                                ì¡°ì§ í‰ê· : ${comp.avg.toFixed(1)}
                            </div>
                            <div style="font-size: 12px; color: ${diff > 0 ? '#27ae60' : diff < 0 ? '#e74c3c' : '#666'}; font-weight: 500;">
                                ${diff > 0 ? '+' : ''}${diff}
                            </div>
                        ` : ''}
                        <div style="height: 4px; background: #e9ecef; border-radius: 2px; overflow: hidden; margin-top: 10px;">
                            <div style="height: 100%; background: ${comp.color}; width: ${comp.score}%; transition: width 0.5s;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ë¹„êµ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        function drawComparisonChart(testResult, companyAverage) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ë¬¸ì œí•´ê²°', 'ì»¤ë®¤ë‹ˆì¼€ì´ì…˜', 'ë¦¬ë”ì‹­', 'ì°½ì˜ì„±', 'íŒ€ì›Œí¬'],
                    datasets: [
                        {
                            label: testResult.user_name,
                            data: [
                                testResult.problem_solving_score,
                                testResult.communication_score,
                                testResult.leadership_score,
                                testResult.creativity_score,
                                testResult.teamwork_score
                            ],
                            backgroundColor: 'rgba(102, 126, 234, 0.25)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#667eea'
                        },
                        {
                            label: 'ì¡°ì§ í‰ê· ',
                            data: [
                                parseFloat(companyAverage.avg_problem_solving),
                                parseFloat(companyAverage.avg_communication),
                                parseFloat(companyAverage.avg_leadership),
                                parseFloat(companyAverage.avg_creativity),
                                parseFloat(companyAverage.avg_teamwork)
                            ],
                            backgroundColor: 'rgba(255, 99, 132, 0.25)',
                            borderColor: '#ff6384',
                            borderWidth: 2,
                            pointBackgroundColor: '#ff6384',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#ff6384'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.r + 'ì ';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ì˜¤ë¥˜ í‘œì‹œ
        function showError(message) {
            document.querySelector('.detail-container').innerHTML = `
                <div class="error-message">
                    ${message}
                </div>
            `;
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = 'admin-login.html';
            }
        }
    </script>
    <!-- ëª¨ë‹¬ íŒŒì¼ ë¡œë“œ -->
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë‹¬ íŒŒì¼ ë¯¸ë¦¬ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', function() {
            loadTestDetailModal();
        });
    </script>
</body>
</html>